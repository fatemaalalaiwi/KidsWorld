{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/game_dashboard.css' %}">

<div class="dashboard-container">

    <h1 class="page-title">{{ game.game_name }} Dashboard</h1>
    
    <div class="game-info">
        <div class="game-info-content">
            <!-- text of the game  -->
            <div class="game-text">
                <p><strong>Selected Game ID:</strong> {{ request.session.selected_game_id }}</p>
                <p><strong>Description:</strong> {{ game.description }}</p>
                <p><strong>Price:</strong> {{ game.game_price }} BD</p>
                <p><strong>Playing Kids Number:</strong> {{ playing_kids_number }}</p>
                <p><strong>All Kids Number:</strong> {{ all_kids_number }}</p>
            </div>

            <!-- image of the game -->
            <div class="game-image">
                <img src="{% static game.game_image|cut:'main_app/static/' %}" alt="{{ game.game_name }}">
            </div>
        </div>
    </div>

    <h3>Kids playing this game:</h3>
    
    {% if kids_playing %}
    <table class="kids-list" style="width:100%; border-collapse: separate; border-spacing: 0 15px;">
        <thead>
            <tr>
                <th>Image</th>
                <th>Kid Name</th>
                <th>Parent Name</th>
                <th>Parent Phone</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Status</th>
                <th>Time Left</th>
            </tr>
        </thead>
        <tbody>
            {% for kg in kids_playing %}
            <tr class="kid-card status-1">
                <td>
                    <img src="{% static kg.fk_kid_id.kid_image|cut:'main_app/static/' %}" alt="{{ kg.fk_kid_id.kid_name }}" class="kid-img" style="width:80px; height:80px; border-radius:12px;">
                </td>
                <td>{{ kg.fk_kid_id.kid_name }}</td>
                <td>{{ kg.fk_kid_id.parent_name }}</td>
                <td>{{ kg.fk_kid_id.parent_phone }}</td>
                <td>{{ kg.start_time|time:"H:i" }}</td>
                <td>{{ kg.end_time|time:"H:i" }}</td>
                <td class="status-text">{{ kg.status }}</td>
                <td>
                    <div class="countdown-container">
                        <span class="countdown" data-endtime="{{ kg.end_time|time:'H:i:s' }}" data-kidgameid="{{ kg.id }}"></span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
      <p class="no-kids">No kids are playing this game yet.</p>
    {% endif %}

</div>

<script>
function startCountdown() {
  const timers = document.querySelectorAll('.countdown');
  timers.forEach(timer => {
    const row = timer.closest('tr');
    const endTimeStr = timer.dataset.endtime;
    const kidGameId = timer.dataset.kidgameid;
    const parts = endTimeStr.split(':');
    const endTime = new Date();
    endTime.setHours(parts[0], parts[1], parts[2] || 0, 0);

    function updateTimer() {
      const diff = endTime - new Date();
      if (diff <= 0) {
        timer.innerHTML = 'Time Up!';
        row.classList.remove('status-1');
        row.classList.add('status-2');
        fetch(`/update_kid_status/${kidGameId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          },
        }).then(() => { location.reload(); });
        return;
      }
      const hours = Math.floor(diff / 1000 / 60 / 60);
      const minutes = Math.floor((diff / 1000 / 60) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      timer.innerHTML = (hours > 0 ? hours + 'h ' : '') + minutes + 'm ' + seconds + 's';
      // تغيير اللون قبل دقيقة واحدة
      if (diff <= 60 * 1000) { 
        row.classList.remove('status-1');
        row.classList.add('status-2');
      }
      setTimeout(updateTimer, 1000);
    }
    updateTimer();
  });
}
document.addEventListener('DOMContentLoaded', startCountdown);
</script>

{% endblock %}
