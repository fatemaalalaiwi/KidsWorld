{% extends 'base.html' %}
{% load static %}
{% block content %}


<link rel="stylesheet" href="{% static 'css/game_dashboard.css' %}">


<div class="dashboard-container">

    <h1 class="page-title">{{ game.game_name }} Dashboard</h1>
    
    <div class="game-info">
        <div class="game-info-content">
            <!-- text of the game  -->
            <div class="game-text">
                <p><strong>Selected Game ID:</strong> {{ request.session.selected_game_id }}</p>
                <p><strong>Description:</strong> {{ game.description }}</p>
                <p><strong>Price:</strong> {{ game.game_price }} BD</p>
                <p><strong>Playing Kids Number:</strong> {{ playing_kids_number }}</p>
                <p><strong>All Kids Number:</strong> {{ all_kids_number }}</p>
            </div>

            <!-- image of the game -->
            <div class="game-image">
                <img src="{% static game.game_image|cut:'main_app/static/' %}" alt="{{ game.game_name }}">
            </div>
        </div>
    </div>

    <h3>Kids playing this game:</h3>
    
    {% if kids_playing %}
      <ul class="kids-list">
        {% for kg in kids_playing %}
          <li class="kid-card status-1">
            <div class="kid-info">
              <p><strong>Kid Name:</strong> {{ kg.fk_kid_id.kid_name }}</p>
              <p><strong>Parent Name:</strong> {{ kg.fk_kid_id.parent_name }}</p>
              <p><strong>Parent Phone:</strong> {{ kg.fk_kid_id.parent_phone }}</p>
              <p><strong>Start Time:</strong> {{ kg.start_time|time:"H:i" }}</p>
              <p><strong>End Time:</strong> {{ kg.end_time|time:"H:i" }}</p>
              <p><strong>Status:</strong> {{ kg.status }}</p>
              <p><strong>Assigned By:</strong> {% if kg.user %}{{ kg.user.username }}{% else %}N/A{% endif %}</p>
            </div>
            <div class="countdown-container">
              <strong>Time Left:</strong>
              <span class="countdown" data-endtime="{{ kg.end_time|time:'H:i:s' }}" data-kidgameid="{{ kg.id }}"></span>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-kids">No kids are playing this game yet.</p>
    {% endif %}

</div>

<!-- Count -->
<script>
function startCountdown() {
  const timers = document.querySelectorAll('.countdown');
  timers.forEach(timer => {
    const endTimeStr = timer.dataset.endtime;
    const li = timer.closest('li');
    const kidGameId = timer.dataset.kidgameid;
    const parts = endTimeStr.split(':');
    const endTime = new Date();
    endTime.setHours(parts[0], parts[1], parts[2] || 0, 0);

    function updateTimer() {
      const diff = endTime - new Date();
      if (diff <= 0) {
        timer.innerHTML = 'Time Up!';
        li.classList.remove('status-1');
        li.classList.add('status-2');
        fetch(`/update_kid_status/${kidGameId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          },
        }).then(() => { location.reload(); });
        return;
      }
      const hours = Math.floor(diff / 1000 / 60 / 60);
      const minutes = Math.floor((diff / 1000 / 60) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      timer.innerHTML = (hours > 0 ? hours + 'h ' : '') + minutes + 'm ' + seconds + 's';
      if (diff <= 60 * 1000) { 
        li.classList.remove('status-1');
        li.classList.add('status-2');
      }
      setTimeout(updateTimer, 1000);
    }
    updateTimer();
  });
}
document.addEventListener('DOMContentLoaded', startCountdown);
</script>


{% endblock %}
